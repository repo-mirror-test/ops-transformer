/**
 * This program is free software, you can redistribute it and/or modify.
 * Copyright (c) 2025 Huawei Technologies Co., Ltd.
 * This file is a part of the CANN Open Software.
 * Licensed under CANN Open Software License Agreement Version 2.0 (the "License").
 * Please refer to the License for details. You may not use this file except in compliance with the License.
 * THIS SOFTWARE IS PROVIDED ON AN "AS IS" BASIS, WITHOUT WARRANTIES OF ANY KIND, EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO NON-INFRINGEMENT, MERCHANTABILITY, OR FITNESS FOR A PARTICULAR PURPOSE.
 * See LICENSE in the root of the software repository for the full text of the License.
 */

/*!
 * \file fused_infer_attention_score_tiling_v3.cpp
 * \brief
 */

#include "fused_infer_attention_score_tiling_v3.h"
#include "fused_infer_attention_score_tiling_check.h"
#include "fused_infer_attention_score_tiling_info_parser.h"
#include "../../../common/op_host/arch32/fia_tiling_nonquant_mla.h"
#include "../../../common/op_host/arch32/fia_tiling_nonquant.h"
#include "../../../common/op_host/arch32/fia_tiling_empty_tensor.h"
#include "../../../common/op_host/fia_tiling_templates_registry.h"

using namespace AscendC;
namespace optiling {
// FIA新TilingKey, 18位编码, IFA原有TilingKey是17位, 新的TilingKey只是把最高位从1X->10X
// MLA dtype: Q=BF16 KV=BF16 OUT=BF16
// MLA PA bf16 kv_NZ
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020222222, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020322222, FusedInferAttentionScoreTilingData)
// MLA PA bf16 kv_BNSD
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000222222, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000322222, FusedInferAttentionScoreTilingData)
// MLA PA bf16 kv_BSH_BSND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010222222, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010322222, FusedInferAttentionScoreTilingData)
// MLA NoPA bf16 kv_BNSD
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000022220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000122220, FusedInferAttentionScoreTilingData)
// MLA NoPA bf16 kv_BSH_BSND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010022221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010122221, FusedInferAttentionScoreTilingData)
// MLA NoPA bf16 kv_TND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000030022222, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000030122222, FusedInferAttentionScoreTilingData)

// MLA dtype: Q=FP16 KV=FP16 OUT=FP16
// MLA PA fp16 kv_NZ
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020200002, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000020300002, FusedInferAttentionScoreTilingData)
// MLA PA fp16 kv_BNSD
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000200002, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000300002, FusedInferAttentionScoreTilingData)
// MLA PA fp16 kv_BSH_BSND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010200002, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010300002, FusedInferAttentionScoreTilingData)
// MLA NoPA fp16 kv_BNSD
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000000000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000000100000, FusedInferAttentionScoreTilingData)
// MLA NoPA fp16 kv_BSH_BSND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010000001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000010100001, FusedInferAttentionScoreTilingData)
// MLA NoPA fp16 kv_TND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000030000002, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000030100002, FusedInferAttentionScoreTilingData)

// 以下是CV1:1场景,目前仅mla模板支持
// MLA dtype: Q=BF16 KV=BF16 OUT=BF16
// MLA PA bf16 kv_NZ
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120222222, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120322222, FusedInferAttentionScoreTilingData)
// MLA PA bf16 kv_BNSD
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100222222, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100322222, FusedInferAttentionScoreTilingData)
// MLA PA bf16 kv_BSH_BSND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110222222, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110322222, FusedInferAttentionScoreTilingData)
// MLA NoPA bf16 kv_BNSD
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100022220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100122220, FusedInferAttentionScoreTilingData)
// MLA NoPA bf16 kv_BSH_BSND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110022221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110122221, FusedInferAttentionScoreTilingData)
// MLA NoPA bf16 kv_TND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000130022222, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000130122222, FusedInferAttentionScoreTilingData)

// MLA dtype: Q=FP16 KV=FP16 OUT=FP16
// MLA PA fp16 kv_NZ
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120200002, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000120300002, FusedInferAttentionScoreTilingData)
// MLA PA fp16 kv_BNSD
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100200002, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100300002, FusedInferAttentionScoreTilingData)
// MLA PA fp16 kv_BSH_BSND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110200002, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110300002, FusedInferAttentionScoreTilingData)
// MLA NoPA fp16 kv_BNSD
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100000000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000100100000, FusedInferAttentionScoreTilingData)
// MLA NoPA fp16 kv_BSH_BSND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110000001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000110100001, FusedInferAttentionScoreTilingData)
// MLA NoPA fp16 kv_TND
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000130000002, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_105000000130100002, FusedInferAttentionScoreTilingData)

// Gqa NoQuant PA dtype: Q=FP16 KV=FP16 OUT=FP16
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000600000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000700000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010600000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010700000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020600000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020700000, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000600001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000700001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010600001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010700001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020600001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020700001, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000200005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000300005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010200005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010300005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020200005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020300005, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000200003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000300003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010200003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010300003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020200003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020300003, FusedInferAttentionScoreTilingData)

REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000000000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010000001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000030000003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000050000005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000100000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010100001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000030100003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000050100005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000400000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010400001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000500000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010500001, FusedInferAttentionScoreTilingData)

// Gqa NoQuant PA dtype: Q=BF16 KV=BF16 OUT=BF16
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000622220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000722220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010622220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010722220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020622220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020722220, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000622221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000722221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010622221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010722221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020622221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020722221, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000222225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000322225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010222225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010322225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020222225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020322225, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000222223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000322223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010222223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010322223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020222223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000020322223, FusedInferAttentionScoreTilingData)

REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000022220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010022221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000030022223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000050022225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000122220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010122221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000030122223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000050122225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000422220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010422221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000050422225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000000522220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000010522221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_103000000050522225, FusedInferAttentionScoreTilingData)
// empty tensor
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_100000000000000020, FusedInferAttentionScoreEmptyTensorTilingData)

// 泛化
// Gqa NoQuant PA dtype: Q=FP16 KV=FP16 OUT=FP16
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000600000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000700000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010600000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010700000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020200000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020300000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020600000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020700000, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000600001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000700001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010600001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010700001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020200001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020300001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020600001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020700001, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000200005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000300005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000600005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000700005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010200005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010300005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010600005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010700005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020200005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020300005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020600005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020700005, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000200003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000300003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000600003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000700003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010200003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010300003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010600003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010700003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020200003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020300003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020600003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020700003, FusedInferAttentionScoreTilingData)

REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000000000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010000001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000030000003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000050000005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000100000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010100001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000030100003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000050100005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000400000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010400001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000030400003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000050400005, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000500000, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010500001, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000030500003, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000050500005, FusedInferAttentionScoreTilingData)

// Gqa NoQuant PA dtype: Q=BF16 KV=BF16 OUT=BF16
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000622220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000722220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010622220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010722220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020222220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020322220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020622220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020722220, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000622221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000722221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010622221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010722221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020222221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020322221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020622221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020722221, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000222225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000322225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000622225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000722225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010222225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010322225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010622225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010722225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020222225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020322225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020622225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020722225, FusedInferAttentionScoreTilingData)
 
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000222223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000322223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000622223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000722223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010222223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010322223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010622223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010722223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020222223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020322223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020622223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000020722223, FusedInferAttentionScoreTilingData)

REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000022220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010022221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000030022223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000050022225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000122220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010122221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000030122223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000050122225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000422220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010422221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000030422223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000050422225, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000000522220, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000010522221, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000030522223, FusedInferAttentionScoreTilingData)
REGISTER_TILING_DATA_CLASS(FusedInferAttentionScore_104000000050522225, FusedInferAttentionScoreTilingData)

constexpr size_t DIM_NZ = 5;
constexpr uint32_t NZ_D1_IDX = 2;
constexpr uint32_t NZ_D0_IDX = 4;
constexpr uint32_t TND_NTD_D_IDX = 2;
constexpr int64_t HEAD_DIM_192 = 192;


FIA_EXTERN_C ge::graphStatus TilingFusedInferAttentionScoreV3(gert::TilingContext *context)
{
    FiaTilingInfo fiaInfo;
    FiaInfoParser fiaInfoParser(context);
    if (fiaInfoParser.Parse(fiaInfo) != ge::GRAPH_SUCCESS) {
        return ge::GRAPH_FAILED;
    }

    // Check函数只做校验，不能修改fiaInfo中的信息
    if (TilingCheck::Check(fiaInfo) != ge::GRAPH_SUCCESS) {
        return ge::GRAPH_FAILED;
    }

    return FiaTilingRegistry::GetInstance().DoTilingImpl(context, &fiaInfo);
}

bool GetPaValueD(const gert::TilingContext *context, int64_t &valueD)
{
    auto attrs = context->GetAttrs();
    int64_t numHeads = static_cast<int64_t>(*attrs->GetAttrPointer<uint32_t>(ATTR_N_INDEX));
    int64_t numKvHeads = static_cast<int64_t>(*attrs->GetAttrPointer<uint32_t>(ATTR_NUM_KV_HEADS_INDEX));
    if (numKvHeads == 0) {
        numKvHeads = numHeads;
    }
    auto vStorageShape = context->GetInputShape(VALUE_INDEX)->GetStorageShape();
    if (vStorageShape.GetDimNum() == DIM_BSH) {
        valueD = vStorageShape.GetDim(BSH_H_IDX) / numKvHeads; // BnBsH
    } else if (vStorageShape.GetDimNum() == DIM_BNSD_OR_BSND) {
        valueD = vStorageShape.GetDim(BNSD_D_IDX); // BnNBsD
    } else if (vStorageShape.GetDimNum() == DIM_NZ) {
        valueD = vStorageShape.GetDim(NZ_D1_IDX) * vStorageShape.GetDim(NZ_D0_IDX); // NZ: BnND1BsD0
    } else {
        return false;
    }
    return true;
}

bool GetValueD(gert::TilingContext *context, int64_t &valueD)
{
    auto vShape = context->GetInputShape(VALUE_INDEX);
    if (vShape == nullptr) {
        return false;
    }
    auto vStorageShape = vShape->GetStorageShape();

    bool isPageAttention = context->GetOptionalInputShape(BLOCK_TABLE_INDEX) != nullptr;
    if (isPageAttention) {
        return GetPaValueD(context, valueD);
    }

    auto attrs = context->GetAttrs();
    int64_t numHeads = static_cast<int64_t>(*attrs->GetAttrPointer<uint32_t>(ATTR_N_INDEX));
    int64_t numKvHeads = static_cast<int64_t>(*attrs->GetAttrPointer<uint32_t>(ATTR_NUM_KV_HEADS_INDEX));
    if (numKvHeads == 0) {
        numKvHeads = numHeads;
    }
    const std::string inputLayoutStr = std::string(context->GetAttrs()->GetAttrPointer<char>(ATTR_INPUT_LAYOUT_INDEX));
    if (inputLayoutStr == "BNSD_BSND" ||
        inputLayoutStr == "BSND_BNSD" ||
        inputLayoutStr == "BNSD_NBSD" ||
        inputLayoutStr == "BSND_NBSD" ||
        inputLayoutStr == "BNSD" ||
        inputLayoutStr == "BSND") {
        if (vStorageShape.GetDimNum() != DIM_BNSD_OR_BSND) {
            return false;
        }
        valueD = vStorageShape.GetDim(BNSD_D_IDX);
    } else if (inputLayoutStr == "BSH" ||
        inputLayoutStr == "BSH_NBSD" ||
        inputLayoutStr == "BSH_BNSD") {
        if (vStorageShape.GetDimNum() != DIM_BSH) {
            return false;
        }
        valueD = vStorageShape.GetDim(BSH_H_IDX) / numKvHeads;
    } else if (inputLayoutStr == "TND" ||
        inputLayoutStr == "NTD" ||
        inputLayoutStr == "TND_NTD" ||
        inputLayoutStr == "NTD_TND") {
        if (vStorageShape.GetDimNum() != DIM_TND) {
            return false;
        }
        valueD = vStorageShape.GetDim(TND_NTD_D_IDX);
    } else {
        return false;
    }

    return true;
}

bool GetQkvD(gert::TilingContext *context, int64_t &queryD, int64_t &queryRopeD, int64_t &valueD)
{
    auto qShape = context->GetInputShape(QUERY_INDEX);
    auto qRopeShape = context->GetOptionalInputShape(QUERY_ROPE_INDEX);
    if (qShape == nullptr) {
        return false;
    }
    auto qStorageShape = qShape->GetStorageShape();
    
    auto attrs = context->GetAttrs();
    if (attrs == nullptr) {
        return false;
    }

    int64_t numHeads = static_cast<int64_t>(*attrs->GetAttrPointer<uint32_t>(ATTR_N_INDEX));
    const std::string inputLayoutStr = std::string(context->GetAttrs()->GetAttrPointer<char>(ATTR_INPUT_LAYOUT_INDEX));
    if (inputLayoutStr == "BNSD_BSND" ||
        inputLayoutStr == "BSND_BNSD" ||
        inputLayoutStr == "BNSD_NBSD" ||
        inputLayoutStr == "BSND_NBSD" ||
        inputLayoutStr == "BNSD" ||
        inputLayoutStr == "BSND") {
        if (qStorageShape.GetDimNum() != DIM_BNSD_OR_BSND) {
            return false;
        }
        queryD = qStorageShape.GetDim(BNSD_D_IDX);
        if (qRopeShape != nullptr) {
            queryRopeD = qRopeShape->GetStorageShape().GetDim(BNSD_D_IDX);
        }
    } else if (inputLayoutStr == "BSH" ||
        inputLayoutStr == "BSH_NBSD" ||
        inputLayoutStr == "BSH_BNSD") {
        if (qStorageShape.GetDimNum() != DIM_BSH) {
            return false;
        }
        queryD = qStorageShape.GetDim(BSH_H_IDX) / numHeads;
        if (qRopeShape != nullptr) {
            queryRopeD = qRopeShape->GetStorageShape().GetDim(BSH_H_IDX) / numHeads;
        }
    } else if (inputLayoutStr == "TND" ||
        inputLayoutStr == "NTD" ||
        inputLayoutStr == "TND_NTD" ||
        inputLayoutStr == "NTD_TND") {
        if (qStorageShape.GetDimNum() != DIM_TND) {
            return false;
        }
        queryD = qStorageShape.GetDim(TND_NTD_D_IDX);
        if (qRopeShape != nullptr) {
            queryRopeD = qRopeShape->GetStorageShape().GetDim(TND_NTD_D_IDX);
        }
    } else {
        return false;
    }

    return GetValueD(context, valueD);
}

bool CheckGqaDSupport(gert::TilingContext *context)
{
    int64_t queryD = 0;
    int64_t queryRopeD = 0;
    int64_t valueD = 0;
    if (GetQkvD(context, queryD, queryRopeD, valueD) != true) {
        return false;
    }
    if ((queryD  == 128 && queryRopeD  == 0 && valueD == 128) || // 128: gqa qkvD
        (queryD  == 64 && queryRopeD  == 0 && valueD == 64) || // 64: gqa qkvD
        (queryD  == 128 && queryRopeD  == 64 && valueD == 128) || // 128: gqa qkvD, 64: mla ropeD
        (queryD  == 192 && queryRopeD  == 0 && valueD == 128)) { // 192: gqa qkD, 128: gqa valueD
        return true;
    }
    return false;
}

bool CheckGqaInputLayoutSupport(const gert::TilingContext *context)
{
    const std::string inputLayoutStr = std::string(context->GetAttrs()->GetAttrPointer<char>(ATTR_INPUT_LAYOUT_INDEX));
    if (inputLayoutStr == "BNSD_BSND" ||
        inputLayoutStr == "BSND_BNSD" ||
        inputLayoutStr == "BNSD" ||
        inputLayoutStr == "BSND" ||
        inputLayoutStr == "BSH_BNSD" ||
        inputLayoutStr == "BSH" ||
        inputLayoutStr == "TND" ||
        inputLayoutStr == "NTD" ||
        inputLayoutStr == "NTD_TND") {
        return true;
    }

    return false;
}

bool IsEmptyTensor(const gert::TilingContext *context)
{
    auto qShape = context->GetInputShape(QUERY_INDEX);
    if ((qShape != nullptr) && (qShape->GetStorageShape().GetShapeSize() == 0)) {
        return true;
    }

    auto attenoutShape = context->GetInputShape(ATTENTION_OUT_INDEX);
    if ((attenoutShape != nullptr) && (attenoutShape->GetStorageShape().GetShapeSize() == 0)) {
        return true;
    }

    bool softmaxLseFlag = context->GetAttrs()->GetAttrPointer<bool>(SOFTMAX_LSE_FLAG_INDEX);
    if (softmaxLseFlag) {
        auto softmaxLseShape = context->GetInputShape(SOFTMAX_LSE_INDEX);
        if ((softmaxLseShape != nullptr) && (softmaxLseShape->GetStorageShape().GetShapeSize() == 0)) {
            return true;
        }
    }

    uint32_t keyBIdx = 0;
    while ((context->GetDynamicInputShape(KEY_INDEX, keyBIdx)) != nullptr) {
        const gert::StorageShape *keyShape = context->GetDynamicInputShape(KEY_INDEX, keyBIdx);
        if (keyShape->GetStorageShape().GetShapeSize() == 0) {
            return true;
        }
        keyBIdx++;
    }

    uint32_t valueBIdx = 0;
    while ((context->GetDynamicInputShape(VALUE_INDEX, valueBIdx)) != nullptr) {
        const gert::StorageShape *valueShape = context->GetDynamicInputShape(VALUE_INDEX, valueBIdx);
        if (valueShape->GetStorageShape().GetShapeSize() == 0) {
            return true;
        }
        valueBIdx++;
    }

    return false;
}

bool CheckGqaFeatureSupport(const gert::TilingContext *context)
{
    auto pseShift = context->GetOptionalInputTensor(PSE_SHIFT_INDEX);
    auto queryPaddingSize = context->GetOptionalInputTensor(QUERY_PADDING_SIZE_INDEX);
    auto kvPaddingSize = context->GetOptionalInputTensor(KV_PADDING_SIZE_INDEX);
    auto keySharedPrefix = context->GetOptionalInputTensor(KEY_SHARED_PREFIX_INDEX);
    auto valueSharedPrefix = context->GetOptionalInputTensor(VALUE_SHARED_PREFIX_INDEX);
    auto actualSharedPrefixLen = context->GetOptionalInputTensor(ACTUAL_SHARED_PREFIX_LEN_INDEX);
    auto quantScale2 = context->GetOptionalInputTensor(QUANT_SCALE2_INDEX);	
    auto quantOffset2 = context->GetOptionalInputTensor(QUANT_OFFSET2_INDEX);	
    if (pseShift != nullptr ||	
        queryPaddingSize != nullptr ||
        kvPaddingSize != nullptr ||
        keySharedPrefix != nullptr ||
        valueSharedPrefix != nullptr ||
        actualSharedPrefixLen != nullptr ||
        quantScale2 != nullptr ||
        quantOffset2 != nullptr) {	
        return false;	
    }
    return true;
}

bool CheckSpecConditions(const gert::TilingContext *context)
{
    auto tempQ = context->GetInputShape(QUERY_INDEX);
    auto tempK = context->GetInputShape(KEY_INDEX);
    auto tempV = context->GetInputShape(VALUE_INDEX);
    auto kvDimNum = tempK->GetStorageShape().GetDimNum();
    auto qRope = context->GetOptionalInputTensor(QUERY_ROPE_INDEX);
    auto kRope = context->GetOptionalInputTensor(KEY_ROPE_INDEX);
    auto tempAttnMaskShape = context->GetOptionalInputShape(ATTEN_MASK_INDEX);
    auto qDataType = context->GetInputDesc(QUERY_INDEX)->GetDataType();

    auto attrs = context->GetAttrs();
    string inputLayoutStr = string(attrs->GetAttrPointer<char>(ATTR_INPUT_LAYOUT_INDEX));
    int32_t headNum = *(attrs->GetAttrPointer<int32_t>(ATTR_N_INDEX));
    int32_t kvHeadNum = *(attrs->GetAttrPointer<int32_t>(ATTR_NUM_KV_HEADS_INDEX));
    int32_t innerPrecise = *(attrs->GetAttrPointer<int32_t>(ATTR_INNER_PRECISE_INDEX));
    int32_t sparseMode = *(attrs->GetAttrPointer<int32_t>(ATTR_SPARSE_MODE_INDEX));
    
    bool isLayoutSupported = (inputLayoutStr == "TND") ? true : false;
    bool isPageAttention = context->GetOptionalInputShape(BLOCK_TABLE_INDEX) != nullptr ? true : false;
    bool isLearnableSink = context->GetOptionalInputTensor(LEARNABLE_SINK_INDEX) != nullptr ? true : false;
    bool sparseModeSupported = (sparseMode == 0) || (sparseMode == 3);
    bool isRopeSplitMla = (qRope != nullptr) && (kRope != nullptr);
    
    bool isMha = (kvHeadNum == 0) || (headNum == kvHeadNum);
    bool mhaConditions = isMha && (tempAttnMaskShape == nullptr) &&
        (qDataType == ge::DT_FLOAT16) && (innerPrecise == 1) && !isPageAttention;
    bool nonMhaConditions = !isMha && (innerPrecise == 0);
    bool specConditionFlag = false;
    if (isLayoutSupported && !isLearnableSink && !isRopeSplitMla && sparseModeSupported &&
        (nonMhaConditions || mhaConditions)) {
        int64_t tempQD = tempQ->GetStorageShape().GetDim(DIM_2);
        if (!isPageAttention) {
            int64_t tempKD = tempK->GetStorageShape().GetDim(DIM_2);
            int64_t tempVD = tempV->GetStorageShape().GetDim(DIM_2);
            bool isFAIDSize = (tempQD <= 256 && tempKD <= 256 && tempVD <= 256) &&
                    (tempQD == tempKD && tempQD == tempVD);
            if (isFAIDSize) {
                specConditionFlag = true;
            }
        } else if (kvDimNum == 3U) {
            int64_t tempKD = (tempK->GetStorageShape().GetDim(DIM_2)) / kvHeadNum;
            int64_t tempVD = (tempV->GetStorageShape().GetDim(DIM_2)) / kvHeadNum;
            int64_t blockSize = tempK->GetStorageShape().GetDim(DIM_1);
            bool isFAIDSize = (tempQD <= 256 && tempKD <= 256 && tempVD <= 256) &&
                    (tempQD == tempKD && tempQD == tempVD);
            if (isFAIDSize && blockSize == 128U) {
                specConditionFlag = true;
            }
        }
    }
    return specConditionFlag;
}

bool isNotLegacyGQA(gert::TilingContext *context)
{
    const std::string inputLayoutStr = std::string(context->GetAttrs()->GetAttrPointer<char>(ATTR_INPUT_LAYOUT_INDEX));
    if (inputLayoutStr != "BSH" &&
        inputLayoutStr != "BSND" &&
        inputLayoutStr != "BNSD" &&
        inputLayoutStr != "BNSD_BSND" &&
        inputLayoutStr != "TND" &&
        inputLayoutStr != "NSD") {
        return true;
    }

    auto queryRope = context->GetOptionalInputTensor(QUERY_ROPE_INDEX);
    auto keyRope = context->GetOptionalInputTensor(KEY_ROPE_INDEX);
    int64_t queryD = 0;
    int64_t queryRopeD = 0;
    int64_t valueD = 0;
    if (GetQkvD(context, queryD, queryRopeD, valueD) != true) {
        return false;
    }

    if (queryD != valueD || queryRope != nullptr || keyRope != nullptr) {
        return true;
    }

    if (inputLayoutStr == "TND" && valueD == HEAD_DIM_192) {
        return false;
    }

    uint32_t keyDimNum = context->GetInputShape(KEY_INDEX)->GetStorageShape().GetDimNum();
    uint32_t valueDimNum = context->GetInputShape(VALUE_INDEX)->GetStorageShape().GetDimNum();
    if ((keyDimNum != DIM_NUM_3 && keyDimNum != DIM_NUM_4) ||
        (valueDimNum != DIM_NUM_3 && valueDimNum != DIM_NUM_4)) {
        return true;
    }

    return false;
}

bool CheckGqaConstrain(gert::TilingContext *context)
{
    if (isNotLegacyGQA(context)) {
        return true;
    }

    if (CheckGqaInputLayoutSupport(context) &&
        CheckGqaDSupport(context) && 
        CheckGqaFeatureSupport(context) &&
        !IsEmptyTensor(context)) { 
            return true;
    }

    return false;
}


bool CheckMlaInputLayoutSupport(const gert::TilingContext *context)
{
    const std::string inputLayoutStr = std::string(context->GetAttrs()->GetAttrPointer<char>(ATTR_INPUT_LAYOUT_INDEX));
    if (inputLayoutStr == "BSH" ||
        inputLayoutStr == "BNSD" ||
        inputLayoutStr == "BSND" ||
        inputLayoutStr == "BNSD_NBSD" ||
        inputLayoutStr == "BSND_NBSD" ||
        inputLayoutStr == "BSH_NBSD" ||
        inputLayoutStr == "TND" ||
        inputLayoutStr == "TND_NTD") {
        return true;
    }

    return false;
}

bool CheckMlaDSupport(gert::TilingContext *context)
{
    int64_t queryD = 0;
    int64_t queryRopeD = 0;
    int64_t valueD = 0;
    if (GetQkvD(context, queryD, queryRopeD, valueD) != true) {
        return false;
    }

    if ((queryD  == 512 && queryRopeD  == 64 && valueD == 512)) { // 512: mla qkvD, 64: mla ropeD
        return true;
    }

    return false;
}

bool CheckMlaConstrain(gert::TilingContext *context)
{
    if (isNotLegacyGQA(context)) {
        return true;
    }

    if (CheckMlaInputLayoutSupport(context) &&
        CheckMlaDSupport(context)) {
        return true;
    }

    return false;
}

bool RouteToFia(gert::TilingContext *context)
{
    if ((context == nullptr) || context->GetAttrs() == nullptr ||
        (context->GetInputDesc(QUERY_INDEX) == nullptr) ||
        (context->GetInputDesc(KEY_INDEX) == nullptr)) {
        return false;
    }
    auto platformInfoPtr = context->GetPlatformInfo();
    auto ascendcPlatform = platform_ascendc::PlatformAscendC(platformInfoPtr);
    if (ascendcPlatform.GetSocVersion() == platform_ascendc::SocVersion::ASCEND310P) {
        return false;
    }

    uint32_t aivNum = ascendcPlatform.GetCoreNumAiv();
    uint32_t aicNum = ascendcPlatform.GetCoreNumAic();
    if((aicNum != aivNum) && (aicNum * 2U != aivNum)) {
        OP_LOGI(context->GetNodeName(), "aicNum(%u):aivNum(%u) only support 1:1 or 1:2.", aicNum, aivNum);
        return false;
    }

    ge::DataType qDataType = context->GetInputDesc(QUERY_INDEX)->GetDataType();
    ge::DataType kDataType = context->GetInputDesc(KEY_INDEX)->GetDataType();
    bool isRopeSplit = (context->GetOptionalInputTensor(QUERY_ROPE_INDEX) != nullptr &&
        context->GetOptionalInputTensor(KEY_ROPE_INDEX) != nullptr);
    if (isRopeSplit) {
        // MLA非量化
        if ((qDataType == ge::DT_FLOAT16 || qDataType == ge::DT_BF16) && (qDataType == kDataType)) {
            if (CheckGqaConstrain(context)) {
                OP_LOGI(context->GetNodeName(), "FIA RopeSplit GQA No quant.");
                return true;
            }
            if (CheckMlaConstrain(context)) {
                OP_LOGI(context->GetNodeName(), "FIA RopeSplit MLA No quant.");
                return true;
            }
            return false;
        }
    } else {
        // GQA非量化
        if ((qDataType == ge::DT_FLOAT16 || qDataType == ge::DT_BF16) && (qDataType == kDataType)) {
            OP_LOGI(context->GetNodeName(), "FIA GQA No quant.");
            if (!CheckSpecConditions(context)) {
                return CheckGqaConstrain(context);
            } else {
                return false;
            }
        }
    }
    return false;
}
} // namespace optiling
